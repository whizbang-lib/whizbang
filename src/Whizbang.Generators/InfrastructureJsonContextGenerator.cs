using System.Text;
using Microsoft.CodeAnalysis;

namespace Whizbang.Generators;

/// <summary>
/// Source generator that creates WhizbangJsonContext with infrastructure types.
/// These are core framework types that need JsonTypeInfo for AOT serialization:
/// MessageHop, SecurityContext, PolicyDecisionTrail, etc.
/// Runs once per compilation using RegisterPostInitializationOutput (no discovery needed).
/// </summary>
[Generator]
public class InfrastructureJsonContextGenerator : IIncrementalGenerator {
  public void Initialize(IncrementalGeneratorInitializationContext context) {
    // Only generate in Whizbang.Core assembly where infrastructure types are defined
    var assemblyName = context.CompilationProvider.Select((c, _) => c.AssemblyName);

    context.RegisterSourceOutput(assemblyName, (ctx, assembly) => {
      // Only generate infrastructure context in Core assembly
      if (assembly != "Whizbang.Core") {
        return;
      }

      var source = GenerateInfrastructureJsonContext();
      ctx.AddSource("WhizbangInfrastructureJsonContext.g.cs", source);
    });
  }

  private static string GenerateInfrastructureJsonContext() {
    var sb = new StringBuilder();

    // File header
    sb.AppendLine("// <auto-generated/>");
    sb.AppendLine($"// Generated by Whizbang InfrastructureJsonContextGenerator at {DateTime.UtcNow:yyyy-MM-ddTHH:mm:ss}Z");
    sb.AppendLine("// DO NOT EDIT - Changes will be overwritten");
    sb.AppendLine("#nullable enable");
    sb.AppendLine();

    // Usings
    sb.AppendLine("using System;");
    sb.AppendLine("using System.Collections.Generic;");
    sb.AppendLine("using System.Text.Json;");
    sb.AppendLine("using System.Text.Json.Serialization;");
    sb.AppendLine("using System.Text.Json.Serialization.Metadata;");
    sb.AppendLine("using Whizbang.Core.Observability;");
    sb.AppendLine("using Whizbang.Core.Policies;");
    sb.AppendLine("using Whizbang.Core.ValueObjects;");
    sb.AppendLine();

    // Namespace
    sb.AppendLine("namespace Whizbang.Core.Generated;");
    sb.AppendLine();

    // Class declaration
    sb.AppendLine("/// <summary>");
    sb.AppendLine("/// Infrastructure JsonSerializerContext with JsonTypeInfo for core Whizbang framework types.");
    sb.AppendLine("/// Implements IJsonTypeInfoResolver for use in resolver chains.");
    sb.AppendLine("/// </summary>");
    sb.AppendLine("public sealed partial class WhizbangInfrastructureJsonContext : JsonSerializerContext, IJsonTypeInfoResolver {");
    sb.AppendLine("  /// <summary>");
    sb.AppendLine("  /// Default singleton instance of WhizbangInfrastructureJsonContext.");
    sb.AppendLine("  /// Use in resolver chains for infrastructure type support.");
    sb.AppendLine("  /// </summary>");
    sb.AppendLine("  public static WhizbangInfrastructureJsonContext Default { get; } = new();");
    sb.AppendLine();
    sb.AppendLine("  public WhizbangInfrastructureJsonContext() : base(null) { }");
    sb.AppendLine("  public WhizbangInfrastructureJsonContext(JsonSerializerOptions options) : base(options) { }");
    sb.AppendLine();

    // JsonSerializerContext override - required by base class
    sb.AppendLine("  /// <summary>");
    sb.AppendLine("  /// No generated serializer options - infrastructure types use dynamic options.");
    sb.AppendLine("  /// </summary>");
    sb.AppendLine("  protected override JsonSerializerOptions? GeneratedSerializerOptions => null;");
    sb.AppendLine();

    // JsonSerializerContext override - GetTypeInfo(Type)
    sb.AppendLine("  /// <summary>");
    sb.AppendLine("  /// Override GetTypeInfo(Type) for compatibility when called directly.");
    sb.AppendLine("  /// </summary>");
    sb.AppendLine("  public override JsonTypeInfo? GetTypeInfo(Type type) {");
    sb.AppendLine("    // When called directly (not in resolver chain), Options might be null");
    sb.AppendLine("    if (Options == null) return null;");
    sb.AppendLine("    return GetTypeInfoInternal(type, Options);");
    sb.AppendLine("  }");
    sb.AppendLine();

    // IJsonTypeInfoResolver implementation
    sb.AppendLine("  /// <summary>");
    sb.AppendLine("  /// Implements IJsonTypeInfoResolver.GetTypeInfo for infrastructure types.");
    sb.AppendLine("  /// </summary>");
    sb.AppendLine("  JsonTypeInfo? IJsonTypeInfoResolver.GetTypeInfo(Type type, JsonSerializerOptions options) {");
    sb.AppendLine("    return GetTypeInfoInternal(type, options);");
    sb.AppendLine("  }");
    sb.AppendLine();

    // GetTypeInfoInternal method
    sb.AppendLine("  private JsonTypeInfo? GetTypeInfoInternal(Type type, JsonSerializerOptions options) {");

    // MessageId
    sb.AppendLine("    if (type == typeof(global::Whizbang.Core.ValueObjects.MessageId)) {");
    sb.AppendLine("      return Create_MessageId(options);");
    sb.AppendLine("    }");

    // CorrelationId
    sb.AppendLine("    if (type == typeof(global::Whizbang.Core.ValueObjects.CorrelationId)) {");
    sb.AppendLine("      return Create_CorrelationId(options);");
    sb.AppendLine("    }");

    // MessageHop
    sb.AppendLine("    if (type == typeof(global::Whizbang.Core.Observability.MessageHop)) {");
    sb.AppendLine("      return Create_MessageHop(options);");
    sb.AppendLine("    }");

    // HopType
    sb.AppendLine("    if (type == typeof(global::Whizbang.Core.Observability.HopType)) {");
    sb.AppendLine("      return Create_HopType(options);");
    sb.AppendLine("    }");

    // SecurityContext
    sb.AppendLine("    if (type == typeof(global::Whizbang.Core.Observability.SecurityContext)) {");
    sb.AppendLine("      return Create_SecurityContext(options);");
    sb.AppendLine("    }");

    // PolicyDecisionTrail
    sb.AppendLine("    if (type == typeof(global::Whizbang.Core.Policies.PolicyDecisionTrail)) {");
    sb.AppendLine("      return Create_PolicyDecisionTrail(options);");
    sb.AppendLine("    }");

    // PolicyDecision
    sb.AppendLine("    if (type == typeof(global::Whizbang.Core.Policies.PolicyDecision)) {");
    sb.AppendLine("      return Create_PolicyDecision(options);");
    sb.AppendLine("    }");

    // List<MessageHop>
    sb.AppendLine("    if (type == typeof(global::System.Collections.Generic.List<global::Whizbang.Core.Observability.MessageHop>)) {");
    sb.AppendLine("      return Create_List_MessageHop(options);");
    sb.AppendLine("    }");

    // List<PolicyDecision>
    sb.AppendLine("    if (type == typeof(global::System.Collections.Generic.List<global::Whizbang.Core.Policies.PolicyDecision>)) {");
    sb.AppendLine("      return Create_List_PolicyDecision(options);");
    sb.AppendLine("    }");

    // Common primitive types
    sb.AppendLine("    if (type == typeof(string)) {");
    sb.AppendLine("      return Create_String(options);");
    sb.AppendLine("    }");
    sb.AppendLine("    if (type == typeof(int)) {");
    sb.AppendLine("      return Create_Int32(options);");
    sb.AppendLine("    }");
    sb.AppendLine("    if (type == typeof(bool)) {");
    sb.AppendLine("      return Create_Boolean(options);");
    sb.AppendLine("    }");
    sb.AppendLine("    if (type == typeof(long)) {");
    sb.AppendLine("      return Create_Int64(options);");
    sb.AppendLine("    }");
    sb.AppendLine("    if (type == typeof(global::System.DateTimeOffset)) {");
    sb.AppendLine("      return Create_DateTimeOffset(options);");
    sb.AppendLine("    }");
    sb.AppendLine("    if (type == typeof(global::System.DateTime)) {");
    sb.AppendLine("      return Create_DateTime(options);");
    sb.AppendLine("    }");
    sb.AppendLine("    if (type == typeof(global::System.Guid)) {");
    sb.AppendLine("      return Create_Guid(options);");
    sb.AppendLine("    }");
    sb.AppendLine("    if (type == typeof(double)) {");
    sb.AppendLine("      return Create_Double(options);");
    sb.AppendLine("    }");
    sb.AppendLine("    if (type == typeof(decimal)) {");
    sb.AppendLine("      return Create_Decimal(options);");
    sb.AppendLine("    }");
    sb.AppendLine("    if (type == typeof(byte[])) {");
    sb.AppendLine("      return Create_ByteArray(options);");
    sb.AppendLine("    }");
    sb.AppendLine("    if (type == typeof(global::System.Collections.Generic.Dictionary<string, string>)) {");
    sb.AppendLine("      return Create_Dictionary_String_String(options);");
    sb.AppendLine("    }");

    sb.AppendLine("    return null;");
    sb.AppendLine("  }");
    sb.AppendLine();

    // Factory methods
    GenerateMessageIdFactory(sb);
    GenerateCorrelationIdFactory(sb);
    GenerateMessageHopFactory(sb);
    GenerateHopTypeFactory(sb);
    GenerateSecurityContextFactory(sb);
    GeneratePolicyDecisionTrailFactory(sb);
    GeneratePolicyDecisionFactory(sb);
    GenerateListMessageHopFactory(sb);
    GenerateListPolicyDecisionFactory(sb);
    GeneratePrimitiveFactories(sb);

    // Close class
    sb.AppendLine("}");

    return sb.ToString();
  }

  private static void GenerateMessageIdFactory(StringBuilder sb) {
    sb.AppendLine("  private static JsonTypeInfo<global::Whizbang.Core.ValueObjects.MessageId> Create_MessageId(JsonSerializerOptions options) {");
    sb.AppendLine("    var converter = new global::Whizbang.Core.ValueObjects.MessageIdJsonConverter();");
    sb.AppendLine("    var jsonTypeInfo = JsonMetadataServices.CreateValueInfo<global::Whizbang.Core.ValueObjects.MessageId>(options, converter);");
    sb.AppendLine("    jsonTypeInfo.OriginatingResolver = Default;");
    sb.AppendLine("    return jsonTypeInfo;");
    sb.AppendLine("  }");
    sb.AppendLine();
  }

  private static void GenerateCorrelationIdFactory(StringBuilder sb) {
    sb.AppendLine("  private static JsonTypeInfo<global::Whizbang.Core.ValueObjects.CorrelationId> Create_CorrelationId(JsonSerializerOptions options) {");
    sb.AppendLine("    var converter = new global::Whizbang.Core.ValueObjects.CorrelationIdJsonConverter();");
    sb.AppendLine("    var jsonTypeInfo = JsonMetadataServices.CreateValueInfo<global::Whizbang.Core.ValueObjects.CorrelationId>(options, converter);");
    sb.AppendLine("    jsonTypeInfo.OriginatingResolver = Default;");
    sb.AppendLine("    return jsonTypeInfo;");
    sb.AppendLine("  }");
    sb.AppendLine();
  }

  private static void GenerateHopTypeFactory(StringBuilder sb) {
    sb.AppendLine("  private static JsonTypeInfo<global::Whizbang.Core.Observability.HopType> Create_HopType(JsonSerializerOptions options) {");
    sb.AppendLine("    var converter = new JsonStringEnumConverter<global::Whizbang.Core.Observability.HopType>();");
    sb.AppendLine("    var jsonTypeInfo = JsonMetadataServices.CreateValueInfo<global::Whizbang.Core.Observability.HopType>(options, converter);");
    sb.AppendLine("    jsonTypeInfo.OriginatingResolver = Default;");
    sb.AppendLine("    return jsonTypeInfo;");
    sb.AppendLine("  }");
    sb.AppendLine();
  }

  private static void GenerateMessageHopFactory(StringBuilder sb) {
    sb.AppendLine("  private static JsonTypeInfo<global::Whizbang.Core.Observability.MessageHop> Create_MessageHop(JsonSerializerOptions options) {");
    sb.AppendLine("    // MessageHop is a record - use reflection metadata services");
    sb.AppendLine("    // TODO: Generate full property metadata for AOT");
    sb.AppendLine("    return JsonMetadataServices.CreateObjectInfo<global::Whizbang.Core.Observability.MessageHop>(");
    sb.AppendLine("      options,");
    sb.AppendLine("      new JsonObjectInfoValues<global::Whizbang.Core.Observability.MessageHop> {");
    sb.AppendLine("        ObjectCreator = null,");
    sb.AppendLine("        PropertyMetadataInitializer = _ => System.Array.Empty<JsonPropertyInfo>()");
    sb.AppendLine("      });");
    sb.AppendLine("  }");
    sb.AppendLine();
  }

  private static void GenerateSecurityContextFactory(StringBuilder sb) {
    sb.AppendLine("  private static JsonTypeInfo<global::Whizbang.Core.Observability.SecurityContext> Create_SecurityContext(JsonSerializerOptions options) {");
    sb.AppendLine("    return JsonMetadataServices.CreateObjectInfo<global::Whizbang.Core.Observability.SecurityContext>(");
    sb.AppendLine("      options,");
    sb.AppendLine("      new JsonObjectInfoValues<global::Whizbang.Core.Observability.SecurityContext> {");
    sb.AppendLine("        ObjectCreator = null,");
    sb.AppendLine("        PropertyMetadataInitializer = _ => System.Array.Empty<JsonPropertyInfo>()");
    sb.AppendLine("      });");
    sb.AppendLine("  }");
    sb.AppendLine();
  }

  private static void GeneratePolicyDecisionTrailFactory(StringBuilder sb) {
    sb.AppendLine("  private static JsonTypeInfo<global::Whizbang.Core.Policies.PolicyDecisionTrail> Create_PolicyDecisionTrail(JsonSerializerOptions options) {");
    sb.AppendLine("    return JsonMetadataServices.CreateObjectInfo<global::Whizbang.Core.Policies.PolicyDecisionTrail>(");
    sb.AppendLine("      options,");
    sb.AppendLine("      new JsonObjectInfoValues<global::Whizbang.Core.Policies.PolicyDecisionTrail> {");
    sb.AppendLine("        ObjectCreator = null,");
    sb.AppendLine("        PropertyMetadataInitializer = _ => System.Array.Empty<JsonPropertyInfo>()");
    sb.AppendLine("      });");
    sb.AppendLine("  }");
    sb.AppendLine();
  }

  private static void GeneratePolicyDecisionFactory(StringBuilder sb) {
    sb.AppendLine("  private static JsonTypeInfo<global::Whizbang.Core.Policies.PolicyDecision> Create_PolicyDecision(JsonSerializerOptions options) {");
    sb.AppendLine("    return JsonMetadataServices.CreateObjectInfo<global::Whizbang.Core.Policies.PolicyDecision>(");
    sb.AppendLine("      options,");
    sb.AppendLine("      new JsonObjectInfoValues<global::Whizbang.Core.Policies.PolicyDecision> {");
    sb.AppendLine("        ObjectCreator = null,");
    sb.AppendLine("        PropertyMetadataInitializer = _ => System.Array.Empty<JsonPropertyInfo>()");
    sb.AppendLine("      });");
    sb.AppendLine("  }");
    sb.AppendLine();
  }

  private static void GenerateListMessageHopFactory(StringBuilder sb) {
    sb.AppendLine("  private static JsonTypeInfo<global::System.Collections.Generic.List<global::Whizbang.Core.Observability.MessageHop>> Create_List_MessageHop(JsonSerializerOptions options) {");
    sb.AppendLine("    return JsonMetadataServices.CreateListInfo<global::System.Collections.Generic.List<global::Whizbang.Core.Observability.MessageHop>, global::Whizbang.Core.Observability.MessageHop>(");
    sb.AppendLine("      options,");
    sb.AppendLine("      new JsonCollectionInfoValues<global::System.Collections.Generic.List<global::Whizbang.Core.Observability.MessageHop>> {");
    sb.AppendLine("        ObjectCreator = () => new global::System.Collections.Generic.List<global::Whizbang.Core.Observability.MessageHop>(),");
    sb.AppendLine("        SerializeHandler = null");
    sb.AppendLine("      });");
    sb.AppendLine("  }");
    sb.AppendLine();
  }

  private static void GenerateListPolicyDecisionFactory(StringBuilder sb) {
    sb.AppendLine("  private static JsonTypeInfo<global::System.Collections.Generic.List<global::Whizbang.Core.Policies.PolicyDecision>> Create_List_PolicyDecision(JsonSerializerOptions options) {");
    sb.AppendLine("    return JsonMetadataServices.CreateListInfo<global::System.Collections.Generic.List<global::Whizbang.Core.Policies.PolicyDecision>, global::Whizbang.Core.Policies.PolicyDecision>(");
    sb.AppendLine("      options,");
    sb.AppendLine("      new JsonCollectionInfoValues<global::System.Collections.Generic.List<global::Whizbang.Core.Policies.PolicyDecision>> {");
    sb.AppendLine("        ObjectCreator = () => new global::System.Collections.Generic.List<global::Whizbang.Core.Policies.PolicyDecision>(),");
    sb.AppendLine("        SerializeHandler = null");
    sb.AppendLine("      });");
    sb.AppendLine("  }");
    sb.AppendLine();
  }

  private static void GeneratePrimitiveFactories(StringBuilder sb) {
    // string
    sb.AppendLine("  private static JsonTypeInfo<string> Create_String(JsonSerializerOptions options) {");
    sb.AppendLine("    return JsonMetadataServices.CreateValueInfo<string>(options, JsonMetadataServices.StringConverter);");
    sb.AppendLine("  }");
    sb.AppendLine();

    // int
    sb.AppendLine("  private static JsonTypeInfo<int> Create_Int32(JsonSerializerOptions options) {");
    sb.AppendLine("    return JsonMetadataServices.CreateValueInfo<int>(options, JsonMetadataServices.Int32Converter);");
    sb.AppendLine("  }");
    sb.AppendLine();

    // bool
    sb.AppendLine("  private static JsonTypeInfo<bool> Create_Boolean(JsonSerializerOptions options) {");
    sb.AppendLine("    return JsonMetadataServices.CreateValueInfo<bool>(options, JsonMetadataServices.BooleanConverter);");
    sb.AppendLine("  }");
    sb.AppendLine();

    // long
    sb.AppendLine("  private static JsonTypeInfo<long> Create_Int64(JsonSerializerOptions options) {");
    sb.AppendLine("    return JsonMetadataServices.CreateValueInfo<long>(options, JsonMetadataServices.Int64Converter);");
    sb.AppendLine("  }");
    sb.AppendLine();

    // DateTimeOffset
    sb.AppendLine("  private static JsonTypeInfo<global::System.DateTimeOffset> Create_DateTimeOffset(JsonSerializerOptions options) {");
    sb.AppendLine("    return JsonMetadataServices.CreateValueInfo<global::System.DateTimeOffset>(options, JsonMetadataServices.DateTimeOffsetConverter);");
    sb.AppendLine("  }");
    sb.AppendLine();

    // DateTime
    sb.AppendLine("  private static JsonTypeInfo<global::System.DateTime> Create_DateTime(JsonSerializerOptions options) {");
    sb.AppendLine("    return JsonMetadataServices.CreateValueInfo<global::System.DateTime>(options, JsonMetadataServices.DateTimeConverter);");
    sb.AppendLine("  }");
    sb.AppendLine();

    // Guid
    sb.AppendLine("  private static JsonTypeInfo<global::System.Guid> Create_Guid(JsonSerializerOptions options) {");
    sb.AppendLine("    return JsonMetadataServices.CreateValueInfo<global::System.Guid>(options, JsonMetadataServices.GuidConverter);");
    sb.AppendLine("  }");
    sb.AppendLine();

    // double
    sb.AppendLine("  private static JsonTypeInfo<double> Create_Double(JsonSerializerOptions options) {");
    sb.AppendLine("    return JsonMetadataServices.CreateValueInfo<double>(options, JsonMetadataServices.DoubleConverter);");
    sb.AppendLine("  }");
    sb.AppendLine();

    // decimal
    sb.AppendLine("  private static JsonTypeInfo<decimal> Create_Decimal(JsonSerializerOptions options) {");
    sb.AppendLine("    return JsonMetadataServices.CreateValueInfo<decimal>(options, JsonMetadataServices.DecimalConverter);");
    sb.AppendLine("  }");
    sb.AppendLine();

    // byte[]
    sb.AppendLine("  private static JsonTypeInfo<byte[]> Create_ByteArray(JsonSerializerOptions options) {");
    sb.AppendLine("    return JsonMetadataServices.CreateValueInfo<byte[]>(options, JsonMetadataServices.ByteArrayConverter);");
    sb.AppendLine("  }");
    sb.AppendLine();

    // Dictionary<string, string>
    sb.AppendLine("  private static JsonTypeInfo<global::System.Collections.Generic.Dictionary<string, string>> Create_Dictionary_String_String(JsonSerializerOptions options) {");
    sb.AppendLine("    return JsonMetadataServices.CreateDictionaryInfo<global::System.Collections.Generic.Dictionary<string, string>, string, string>(");
    sb.AppendLine("      options,");
    sb.AppendLine("      new JsonCollectionInfoValues<global::System.Collections.Generic.Dictionary<string, string>> {");
    sb.AppendLine("        ObjectCreator = () => new global::System.Collections.Generic.Dictionary<string, string>(),");
    sb.AppendLine("        SerializeHandler = null");
    sb.AppendLine("      });");
    sb.AppendLine("  }");
    sb.AppendLine();
  }
}
