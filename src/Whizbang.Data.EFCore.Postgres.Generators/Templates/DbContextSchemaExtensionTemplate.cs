#region HEADER
// <auto-generated/>
// Generated at: __TIMESTAMP__
#endregion
#nullable enable

using System.Text.RegularExpressions;
using System.Threading;
using System.Threading.Tasks;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Logging;

namespace __DBCONTEXT_NAMESPACE__.Generated;

/// <summary>
/// Extension methods for __DBCONTEXT_CLASS__ schema initialization.
/// </summary>
public static class __DBCONTEXT_CLASS__SchemaExtensions {
  /// <summary>
  /// Ensures Whizbang database schema is fully initialized for __DBCONTEXT_CLASS__.
  /// Creates tables from entity configurations (ConfigureWhizbang() in OnModelCreating)
  /// and executes PostgreSQL functions/migrations.
  /// Idempotent - safe to call multiple times.
  ///
  /// Steps:
  /// 1. Creates tables with IF NOT EXISTS (post-processed EF Core script)
  /// 2. Executes PostgreSQL functions (process_work_batch, etc.)
  /// </summary>
  /// <param name="dbContext">The __DBCONTEXT_CLASS__ instance</param>
  /// <param name="logger">Optional logger for diagnostic messages</param>
  /// <param name="cancellationToken">Cancellation token</param>
  public static async Task EnsureWhizbangDatabaseInitializedAsync(
    this __DBCONTEXT_FQN__ dbContext,
    ILogger? logger = null,
    CancellationToken cancellationToken = default) {

    // Step 1: Create tables
    logger?.LogInformation("Creating Whizbang tables for {DbContext}...", "__DBCONTEXT_CLASS__");
    var script = dbContext.Database.GenerateCreateScript();
    script = MakeScriptIdempotent(script);

    // Only execute if script is not empty (DbContext may have no user-defined entities)
    if (!string.IsNullOrWhiteSpace(script)) {
      try {
        await dbContext.Database.ExecuteSqlRawAsync(script, cancellationToken);
        logger?.LogInformation("Whizbang tables created successfully");
      } catch (Npgsql.PostgresException ex) when (ex.SqlState == "42P07") {
        // 42P07 = duplicate_table - Unexpected! Script should be idempotent.
        logger?.LogWarning(
          "Caught duplicate_table exception despite IF NOT EXISTS. " +
          "Table: {Table}, SqlState: {SqlState}",
          ex.TableName ?? "unknown",
          ex.SqlState);
      }
    } else {
      logger?.LogInformation("No user-defined tables to create (DbContext has no perspectives)");
    }

    // Step 2: Create PostgreSQL functions
    logger?.LogInformation("Creating Whizbang PostgreSQL functions...");
    await ExecuteMigrationsAsync(dbContext, logger, cancellationToken);
    logger?.LogInformation("Whizbang database initialization complete");
  }

  /// <summary>
  /// Executes PostgreSQL migration scripts to create functions.
  /// Migrations are embedded as string constants for AOT compatibility.
  /// </summary>
  private static async Task ExecuteMigrationsAsync(
    __DBCONTEXT_FQN__ dbContext,
    ILogger? logger,
    CancellationToken cancellationToken) {

    // Migration scripts are embedded below by the source generator
    var migrations = GetMigrationScripts();

    foreach (var (name, sql) in migrations) {
      try {
        logger?.LogInformation("Executing migration: {Migration}", name);
        await dbContext.Database.ExecuteSqlRawAsync(sql, cancellationToken);
        logger?.LogInformation("Migration {Migration} completed successfully", name);
      } catch (Npgsql.PostgresException ex) when (ex.SqlState == "42723") {
        // 42723 = duplicate_function - function already exists, safe to ignore
        logger?.LogInformation("Function already exists (expected): {Message}", ex.MessageText);
      } catch (Exception ex) {
        logger?.LogError(ex, "Failed to execute migration {Migration}", name);
        throw;
      }
    }
  }

  /// <summary>
  /// Returns migration scripts as (name, sql) tuples.
  /// Scripts are embedded by the source generator.
  /// </summary>
  private static (string Name, string Sql)[] GetMigrationScripts() {
    return new[] {
      #region MIGRATIONS
      // Migration scripts will be embedded here by the source generator
      #endregion
    };
  }

  /// <summary>
  /// Post-processes EF Core's generated SQL to add IF NOT EXISTS clauses.
  /// Makes CREATE TABLE and CREATE INDEX statements idempotent.
  /// </summary>
  private static string MakeScriptIdempotent(string script) {
    // Add IF NOT EXISTS to CREATE TABLE statements
    // Pattern: CREATE TABLE table_name (
    // Replace: CREATE TABLE IF NOT EXISTS table_name (
    script = Regex.Replace(
      script,
      @"CREATE TABLE (\w+) \(",
      "CREATE TABLE IF NOT EXISTS $1 (",
      RegexOptions.Multiline);

    // Add IF NOT EXISTS to CREATE INDEX statements
    // Pattern: CREATE INDEX index_name ON
    // Replace: CREATE INDEX IF NOT EXISTS index_name ON
    // Also handles: CREATE UNIQUE INDEX
    script = Regex.Replace(
      script,
      @"CREATE (UNIQUE )?INDEX ([""'\w]+) ON",
      "CREATE $1INDEX IF NOT EXISTS $2 ON",
      RegexOptions.Multiline);

    return script;
  }
}
