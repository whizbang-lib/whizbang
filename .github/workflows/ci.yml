name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  version:
    name: Version
    uses: ./.github/workflows/reusable-version.yml

  build:
    name: Build
    needs: version
    uses: ./.github/workflows/reusable-build.yml

  unit-tests:
    name: Unit Tests
    uses: ./.github/workflows/reusable-test-unit.yml

  postgres-integration:
    name: PostgreSQL Integration
    uses: ./.github/workflows/reusable-test-postgres.yml

  inmemory-integration:
    name: InMemory Integration
    uses: ./.github/workflows/reusable-test-inmemory.yml

  rabbitmq-integration:
    name: RabbitMQ Integration
    uses: ./.github/workflows/reusable-test-rabbitmq.yml

  servicebus-integration:
    name: Service Bus Integration
    uses: ./.github/workflows/reusable-test-servicebus.yml

  quality:
    name: Quality
    needs: [unit-tests, postgres-integration, inmemory-integration, rabbitmq-integration, servicebus-integration]
    uses: ./.github/workflows/reusable-quality.yml
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  version-comment:
    name: Comment Version on PR
    needs: version
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Delete Previous Version Comments
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          # Find and delete previous version comments (identified by the ðŸ“¦ emoji)
          gh api "repos/$REPO/issues/$PR_NUMBER/comments" --jq '.[] | select(.body | startswith("ðŸ“¦")) | .id' | while read -r comment_id; do
            echo "Deleting previous version comment: $comment_id"
            gh api --method DELETE "repos/$REPO/issues/comments/$comment_id"
          done

      - name: Comment Version
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          SEMVER: ${{ needs.version.outputs.semver }}
          FULLSEMVER: ${{ needs.version.outputs.fullsemver }}
          PRERELEASE: ${{ needs.version.outputs.prerelease || 'none' }}
        run: |
          gh pr comment "$PR_NUMBER" \
            --repo "$REPO" \
            --body "ðŸ“¦ **Calculated Version**: \`$SEMVER\`

          | Property | Value |
          |----------|-------|
          | SemVer | \`$SEMVER\` |
          | Full SemVer | \`$FULLSEMVER\` |
          | Pre-release | \`$PRERELEASE\` |"
