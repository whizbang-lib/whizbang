name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build
    uses: ./.github/workflows/reusable-build.yml

  unit-tests:
    name: Unit Tests
    needs: build
    uses: ./.github/workflows/reusable-test-unit.yml
    with:
      build-artifact: ${{ needs.build.outputs.artifact_name }}

  postgres-integration:
    name: PostgreSQL Integration
    needs: build
    uses: ./.github/workflows/reusable-test-postgres.yml
    with:
      build-artifact: ${{ needs.build.outputs.artifact_name }}

  inmemory-integration:
    name: InMemory Integration
    needs: build
    uses: ./.github/workflows/reusable-test-inmemory.yml
    with:
      build-artifact: ${{ needs.build.outputs.artifact_name }}

  rabbitmq-integration:
    name: RabbitMQ Integration
    needs: build
    uses: ./.github/workflows/reusable-test-rabbitmq.yml
    with:
      build-artifact: ${{ needs.build.outputs.artifact_name }}

  servicebus-integration:
    name: Service Bus Integration
    needs: build
    uses: ./.github/workflows/reusable-test-servicebus.yml
    with:
      build-artifact: ${{ needs.build.outputs.artifact_name }}
