name: Release

on:
  # Trigger when a release PR is merged to main
  pull_request:
    types: [closed]
    branches: [main]

  # Keep manual trigger for dry runs
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (calculate version only, no tag or release)'
        required: false
        default: true
        type: boolean

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

permissions:
  contents: write
  id-token: write

jobs:
  # Only run if this is a merged release PR or a manual dry run
  check-release:
    name: Check Release Conditions
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: Check if release should proceed
        id: check
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Manual trigger - dry run mode"
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "version=" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.pull_request.merged }}" == "true" ]; then
            # Check if PR title matches release pattern
            PR_TITLE="${{ github.event.pull_request.title }}"
            if [[ "$PR_TITLE" =~ ^chore\(release\):\ v([0-9]+\.[0-9]+\.[0-9]+.*) ]]; then
              VERSION="${BASH_REMATCH[1]}"
              echo "Release PR merged - version: $VERSION"
              echo "should_release=true" >> $GITHUB_OUTPUT
              echo "version=$VERSION" >> $GITHUB_OUTPUT
            else
              echo "PR merged but not a release PR"
              echo "should_release=false" >> $GITHUB_OUTPUT
              echo "version=" >> $GITHUB_OUTPUT
            fi
          else
            echo "PR not merged, skipping"
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "version=" >> $GITHUB_OUTPUT
          fi

  version:
    name: Calculate Version
    needs: check-release
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      semver: ${{ steps.gitversion.outputs.semVer }}

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@26a89e5dd4fa9ba66a853e04706ba52755ca4057 # v3.1.1
        with:
          versionSpec: '6.0.x'

      - name: Determine Version
        id: gitversion
        uses: gittools/actions/gitversion/execute@26a89e5dd4fa9ba66a853e04706ba52755ca4057 # v3.1.1
        with:
          useConfigFile: true
          configFilePath: GitVersion.yml

      - name: Display Version Info
        run: |
          echo "## Version Information (Dry Run)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| SemVer | ${{ steps.gitversion.outputs.semVer }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Major | ${{ steps.gitversion.outputs.major }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Minor | ${{ steps.gitversion.outputs.minor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Patch | ${{ steps.gitversion.outputs.patch }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*This was a dry run. Use 'Start Release' workflow to create a release PR.*" >> $GITHUB_STEP_SUMMARY

  release:
    name: Create Release
    needs: check-release
    if: needs.check-release.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create and Push Tag
        run: |
          VERSION="${{ needs.check-release.outputs.version }}"
          TAG="v$VERSION"

          echo "Creating tag: $TAG"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

      - name: Determine if Prerelease
        id: prerelease
        run: |
          VERSION="${{ needs.check-release.outputs.version }}"
          if [[ "$VERSION" == *-* ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release (stable)
        if: steps.prerelease.outputs.is_prerelease == 'false'
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: v${{ needs.check-release.outputs.version }}
          name: Release v${{ needs.check-release.outputs.version }}
          generate_release_notes: true
          prerelease: false

      - name: Create GitHub Pre-Release
        if: steps.prerelease.outputs.is_prerelease == 'true'
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: v${{ needs.check-release.outputs.version }}
          name: Pre-release v${{ needs.check-release.outputs.version }}
          generate_release_notes: true
          prerelease: true

      - name: Summary
        run: |
          echo "## Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: v${{ needs.check-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: [v${{ needs.check-release.outputs.version }}](https://github.com/${{ github.repository }}/releases/tag/v${{ needs.check-release.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The NuGet publish workflow will be triggered next." >> $GITHUB_STEP_SUMMARY

  publish:
    name: Publish to NuGet
    needs: [check-release, release]
    if: needs.check-release.outputs.should_release == 'true'
    uses: ./.github/workflows/nuget-publish.yml
    with:
      tag: v${{ needs.check-release.outputs.version }}
