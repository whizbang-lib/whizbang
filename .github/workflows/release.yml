name: Release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto       # Use GitVersion calculated version
          - major      # Force major version bump (x.0.0)
          - minor      # Force minor version bump (0.x.0)
          - patch      # Force patch version bump (0.0.x)
      dry_run:
        description: 'Dry run (no tag or release created)'
        required: false
        default: false
        type: boolean

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

# Top-level permissions for the workflow
permissions:
  contents: write   # For committing version changes and pushing tags
  id-token: write   # For OIDC trusted publishing (inherited by reusable workflows)

jobs:
  version:
    name: Calculate Version
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      semver: ${{ steps.final_version.outputs.semver }}
      major: ${{ steps.final_version.outputs.major }}
      minor: ${{ steps.final_version.outputs.minor }}
      patch: ${{ steps.final_version.outputs.patch }}
      prerelease: ${{ steps.final_version.outputs.prerelease }}
      fullsemver: ${{ steps.final_version.outputs.fullsemver }}
      informationalversion: ${{ steps.gitversion.outputs.informationalVersion }}
      branchname: ${{ steps.gitversion.outputs.branchName }}
      sha: ${{ steps.gitversion.outputs.sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0  # Full history required for GitVersion

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@26a89e5dd4fa9ba66a853e04706ba52755ca4057 # v3.1.1
        with:
          versionSpec: '6.0.x'

      - name: Determine Base Version
        id: gitversion
        uses: gittools/actions/gitversion/execute@26a89e5dd4fa9ba66a853e04706ba52755ca4057 # v3.1.1
        with:
          useConfigFile: true
          configFilePath: GitVersion.yml

      - name: Calculate Final Version
        id: final_version
        run: |
          MAJOR=${{ steps.gitversion.outputs.major }}
          MINOR=${{ steps.gitversion.outputs.minor }}
          PATCH=${{ steps.gitversion.outputs.patch }}
          PRERELEASE="${{ steps.gitversion.outputs.preReleaseTag }}"

          case "${{ inputs.release_type }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
            auto)
              # Use GitVersion's calculated version as-is
              ;;
          esac

          if [ -n "$PRERELEASE" ]; then
            SEMVER="${MAJOR}.${MINOR}.${PATCH}-${PRERELEASE}"
            FULLSEMVER="${MAJOR}.${MINOR}.${PATCH}-${PRERELEASE}"
          else
            SEMVER="${MAJOR}.${MINOR}.${PATCH}"
            FULLSEMVER="${MAJOR}.${MINOR}.${PATCH}"
          fi

          echo "semver=$SEMVER" >> $GITHUB_OUTPUT
          echo "fullsemver=$FULLSEMVER" >> $GITHUB_OUTPUT
          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT
          echo "patch=$PATCH" >> $GITHUB_OUTPUT
          echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT

          echo "Final version: $SEMVER"

      - name: Display Version Info
        run: |
          echo "## Version Information" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| SemVer | ${{ steps.final_version.outputs.semver }} |" >> $GITHUB_STEP_SUMMARY
          echo "| FullSemVer | ${{ steps.final_version.outputs.fullsemver }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Major | ${{ steps.final_version.outputs.major }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Minor | ${{ steps.final_version.outputs.minor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Patch | ${{ steps.final_version.outputs.patch }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PreRelease | ${{ steps.final_version.outputs.prerelease }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ steps.gitversion.outputs.branchName }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SHA | ${{ steps.gitversion.outputs.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Release Type | ${{ inputs.release_type }} |" >> $GITHUB_STEP_SUMMARY

          echo ""
          echo "Calculated version: ${{ steps.final_version.outputs.semver }}"
          echo "Full SemVer: ${{ steps.final_version.outputs.fullsemver }}"

  release:
    name: Create Release
    needs: version
    runs-on: ubuntu-latest
    if: ${{ !inputs.dry_run }}
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check if version already exists
        run: |
          VERSION="${{ needs.version.outputs.semver }}"
          TAG="v$VERSION"

          # Check if tag already exists
          if git tag -l "$TAG" | grep -q "$TAG"; then
            echo "::error::Tag $TAG already exists locally"
            exit 1
          fi

          # Check if tag exists on remote
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG"; then
            echo "::error::Tag $TAG already exists on remote. Version $VERSION has already been released."
            echo ""
            echo "To release a new version, ensure your changes include commits that would bump the version:"
            echo "  - feat: commits bump minor version"
            echo "  - fix: commits bump patch version"
            echo "  - BREAKING CHANGE: bumps major version"
            echo ""
            echo "Or manually specify a release_type (major/minor/patch) when running this workflow."
            exit 1
          fi

          echo "âœ… Version $VERSION is available for release"

      - name: Update Version in Directory.Build.props
        run: |
          VERSION="${{ needs.version.outputs.semver }}"
          echo "Updating version to: $VERSION"

          # Update the version in Directory.Build.props using sed
          sed -i "s|<Version>[^<]*</Version>|<Version>$VERSION</Version>|g" Directory.Build.props

          # Verify the change
          grep "<Version>" Directory.Build.props

      - name: Commit Version Change
        run: |
          VERSION="${{ needs.version.outputs.semver }}"
          git add Directory.Build.props
          git commit -m "chore(release): bump version to $VERSION" || echo "No changes to commit"

      - name: Create and Push Tag
        run: |
          VERSION="${{ needs.version.outputs.semver }}"
          TAG="v$VERSION"

          echo "Creating tag: $TAG"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin HEAD:${{ github.ref_name }}
          git push origin "$TAG"

      - name: Create GitHub Release (stable only)
        if: ${{ needs.version.outputs.prerelease == '' }}
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: v${{ needs.version.outputs.semver }}
          name: Release v${{ needs.version.outputs.semver }}
          generate_release_notes: true
          prerelease: false

      - name: Create GitHub Pre-Release
        if: ${{ needs.version.outputs.prerelease != '' }}
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: v${{ needs.version.outputs.semver }}
          name: Pre-release v${{ needs.version.outputs.semver }}
          generate_release_notes: true
          prerelease: true

      - name: Summary
        run: |
          echo "## Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: v${{ needs.version.outputs.semver }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: [v${{ needs.version.outputs.semver }}](https://github.com/${{ github.repository }}/releases/tag/v${{ needs.version.outputs.semver }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The NuGet publish workflow will be triggered next." >> $GITHUB_STEP_SUMMARY

  publish:
    name: Publish to NuGet
    needs: [version, release]
    if: ${{ !inputs.dry_run }}
    uses: ./.github/workflows/nuget-publish.yml
    with:
      tag: v${{ needs.version.outputs.semver }}
    # Note: No secrets needed - nuget-publish.yml uses OIDC trusted publishing
    # which relies on id-token permission (declared in the called workflow),
    # not repository secrets
